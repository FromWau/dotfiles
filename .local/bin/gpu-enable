#!/bin/bash
# Re-enable NVIDIA GPU from drain mode with fzf selection

LOG_FILE="/tmp/gpu-enable.log"

set -e

# Initialize log file
sudo touch "$LOG_FILE"
sudo chmod 666 "$LOG_FILE"
echo "=== GPU Enable Script Started at $(date) ===" > "$LOG_FILE"

# Get list of ALL NVIDIA GPUs from lspci
ALL_GPUS=$(lspci -d 10de: | grep -i vga)

# Get list of ACTIVE GPUs from nvidia-smi (drained GPUs won't show here)
ACTIVE_PCI_IDS=$(nvidia-smi --query-gpu=pci.bus_id --format=csv,noheader 2>/dev/null | \
    sed 's/^00000000://' | sed 's/^0000://')

# Find drained GPUs (in lspci but not in nvidia-smi)
DRAINED_GPUS=""
while IFS= read -r line; do
    if [ -z "$line" ]; then continue; fi

    # Extract PCI address and name
    PCI=$(echo "$line" | awk '{print $1}')
    NAME=$(echo "$line" | sed 's/^[^ ]* //')

    # Check if this PCI ID is NOT in the active list
    if ! echo "$ACTIVE_PCI_IDS" | grep -q "$PCI"; then
        DRAINED_GPUS="${DRAINED_GPUS}${PCI} ${NAME}"$'\n'
        echo "Found drained GPU: $PCI $NAME" >> "$LOG_FILE"
    fi
done <<< "$ALL_GPUS"

# Remove trailing newline
GPU_LIST=$(echo -n "$DRAINED_GPUS")

if [ -z "$GPU_LIST" ]; then
    echo "Error: No drained NVIDIA GPUs found"
    echo "All GPUs are already enabled or no NVIDIA GPUs are present"
    exit 1
fi

# Let user select GPU with fzf
SELECTED=$(echo "$GPU_LIST" | fzf --prompt="Select GPU to enable: " --height=10)

if [ -z "$SELECTED" ]; then
    echo "No GPU selected. Aborted."
    exit 1
fi

# Extract PCI address (first field before the space)
GPU_PCI=$(echo "$SELECTED" | awk '{print $1}')
GPU_NAME=$(echo "$SELECTED" | sed 's/^[^ ]* //')

# Convert to full PCI address format (XX:YY.Z -> 0000:XX:YY.Z)
if [[ ! "$GPU_PCI" =~ ^0000: ]]; then
    GPU_PCI="0000:$GPU_PCI"
fi

echo "Selected: $GPU_NAME"
echo "PCI Address: $GPU_PCI"

# Check current drain status
DRAIN_STATUS=$(sudo nvidia-smi drain --pciid "$GPU_PCI" --query 2>&1 || echo "unknown")
if echo "$DRAIN_STATUS" | grep -qi "drain.*disabled"; then
    echo "This GPU is not in drain mode (already enabled)"
    exit 0
fi

echo ""
echo "Re-enabling the GPU will restore full functionality."
while true; do
    read -p "Enable this GPU? (yes/NO): " -r
    case "${REPLY,,}" in
    yes | y)
        break
        ;;
    no | n | "")
        echo "Aborted."
        exit 1
        ;;
    *)
        echo "Please enter 'yes' or 'no' (or press Enter for no)"
        ;;
    esac
done

echo "Re-enabling GPU..."

# Disable drain mode
if sudo nvidia-smi drain --pciid "$GPU_PCI" --modify 0 >> "$LOG_FILE" 2>&1; then
    echo "Drain mode disabled for $GPU_PCI" | tee -a "$LOG_FILE"
else
    echo "ERROR: Failed to disable drain mode for $GPU_PCI" | tee -a "$LOG_FILE"
    exit 1
fi

# Enable persistence mode for all GPUs
if sudo nvidia-smi --persistence-mode=1 >> "$LOG_FILE" 2>&1; then
    echo "Persistence mode enabled for all GPUs" | tee -a "$LOG_FILE"
else
    echo "WARNING: Failed to enable persistence mode" | tee -a "$LOG_FILE"
fi

echo ""
echo "GPU $GPU_NAME has been re-enabled successfully!"
echo "Log saved to: $LOG_FILE"
echo ""
echo "You may want to restart your display manager to fully activate:"
echo "  sudo systemctl restart sddm"
