#!/bin/bash
# Re-enable ALL drained NVIDIA GPUs (non-interactive)

LOG_FILE="/tmp/gpu-enable.log"

set -e

# Initialize log file
sudo touch "$LOG_FILE"
sudo chmod 666 "$LOG_FILE"
echo "=== GPU Enable Script Started at $(date) ===" > "$LOG_FILE"

# Get list of ALL NVIDIA GPUs from lspci
ALL_GPUS=$(lspci -d 10de: | grep -i vga)

# Get list of ACTIVE GPUs from nvidia-smi (drained GPUs won't show here)
ACTIVE_PCI_IDS=$(nvidia-smi --query-gpu=pci.bus_id --format=csv,noheader 2>/dev/null | \
    sed 's/^00000000://' | sed 's/^0000://')

# Find drained GPUs (in lspci but not in nvidia-smi)
DRAINED_GPUS=()
while IFS= read -r line; do
    if [ -z "$line" ]; then continue; fi

    # Extract PCI address and name
    PCI=$(echo "$line" | awk '{print $1}')
    NAME=$(echo "$line" | sed 's/^[^ ]* //')

    # Check if this PCI ID is NOT in the active list
    if ! echo "$ACTIVE_PCI_IDS" | grep -q "$PCI"; then
        DRAINED_GPUS+=("$PCI|$NAME")
        echo "Found drained GPU: $PCI $NAME" >> "$LOG_FILE"
    fi
done <<< "$ALL_GPUS"

if [ ${#DRAINED_GPUS[@]} -eq 0 ]; then
    echo "No drained NVIDIA GPUs found - all GPUs are already enabled" | tee -a "$LOG_FILE"
    exit 0
fi

echo "Re-enabling ${#DRAINED_GPUS[@]} drained GPU(s)..." | tee -a "$LOG_FILE"

# Enable all drained GPUs
for gpu_entry in "${DRAINED_GPUS[@]}"; do
    GPU_PCI=$(echo "$gpu_entry" | cut -d'|' -f1)
    GPU_NAME=$(echo "$gpu_entry" | cut -d'|' -f2)

    # Convert to full PCI address format (XX:YY.Z -> 0000:XX:YY.Z)
    if [[ ! "$GPU_PCI" =~ ^0000: ]]; then
        GPU_PCI="0000:$GPU_PCI"
    fi

    echo "Enabling: $GPU_NAME ($GPU_PCI)" | tee -a "$LOG_FILE"

    # Disable drain mode
    if sudo nvidia-smi drain --pciid "$GPU_PCI" --modify 0 >> "$LOG_FILE" 2>&1; then
        echo "  ✓ Drain mode disabled for $GPU_PCI" | tee -a "$LOG_FILE"
    else
        echo "  ✗ ERROR: Failed to disable drain mode for $GPU_PCI" | tee -a "$LOG_FILE"
    fi
done

# Enable persistence mode for all GPUs
if sudo nvidia-smi --persistence-mode=1 >> "$LOG_FILE" 2>&1; then
    echo "Persistence mode enabled for all GPUs" | tee -a "$LOG_FILE"
else
    echo "WARNING: Failed to enable persistence mode" | tee -a "$LOG_FILE"
fi

echo ""
echo "All GPUs have been re-enabled successfully!" | tee -a "$LOG_FILE"
echo "Log saved to: $LOG_FILE"
echo ""
echo "You may want to restart your display manager to fully activate:"
echo "  sudo systemctl restart sddm"
